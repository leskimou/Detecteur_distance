// Broches pour le capteur ultrason
const unsigned int TRIG_PIN = 2;
const unsigned int ECHO_PIN = 3;

// LED intégrée
const int LED_PIN = 13;

// Autres constantes
const unsigned int BAUD_RATE = 9600;

void setup() {
  // Configurer les broches du capteur ultrason
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);

  // Configurer la LED intégrée
  pinMode(LED_PIN, OUTPUT);

  // Initialisation de la communication série
  Serial.begin(BAUD_RATE);
}

void loop() {
  // Mesurer la distance
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);

  unsigned long duration = pulseIn(ECHO_PIN, HIGH);
  float distance = duration / 29.0 / 2.0;

  // Vérifier si le capteur retourne une valeur valide
  if (duration == 0) {
    Serial.println("Warning: no pulse from sensor");
    digitalWrite(LED_PIN, LOW); // Éteint la LED intégrée
  } else {
    // Limiter et convertir la distance en entier
    int distanceInt = (int)distance;
    if (distanceInt > 99) distanceInt = 99;

    // Faire clignoter la LED intégrée en fonction de la distance
    int blinkDelay = map(distanceInt, 0, 200, 50, 1000); // Mapper la distance en cadence (50 ms à 1000 ms)
    blinkLED(blinkDelay);

    // Envoyer la distance via Serial
    Serial.println(distanceInt);
  }

  delay(100);  // Délai avant la prochaine mesure
}

// Fonction pour faire clignoter la LED intégrée
void blinkLED(int delayTime) {
  digitalWrite(LED_PIN, HIGH);
  delay(delayTime / 2);
  digitalWrite(LED_PIN, LOW);
  delay(delayTime / 2);
}